<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>
    <script>
        var defaultBoxColor = 'firebrick';
        var selectedBoxColor = 'pink';
    </script>
</head>

<body style="overflow:hidden; height: 100vh;">

    <h1>This is a Heading</h1>
    <p>This is a paragraph.</p>

    <div>up power:
        <span id="vel"></span>
    </div>
    <div>selected:
        <span id="selebox"></span>
    </div>

    <script src="node_modules/matter-js/build/matter.js"></script>
    <script src="index.js"></script>
    <script>
        var selectedBox = 0;
        document.getElementById('selebox').innerText = selectedBox;

        var keyupTimer = 0;
        let velInterval = null;

        document.addEventListener('keydown', ev => {
            if (ev.keyCode === 38) {
                // up
                if (keyupTimer === 0) {
                    keyupTimer = Date.now();
                    velInterval = setInterval(() => document.getElementById('vel').innerText = -getUpVel(), 10);
                }
            }
        })

        let getUpVel = () => {
            if (keyupTimer === 0) return 0;
            let vel = -(Date.now() - keyupTimer) / 80;
            vel = vel < -20 ? -20 : vel;
            return vel;
        }

        document.addEventListener('keyup', ev => {
            if (ev.keyCode === 116) return;
            // locknuti kostky ve vzduchu - spawnout novou kostku - cil je dostat se co nejvejs s co nejmin kostkama
            console.debug(selectedBox)
            let allK = Composite.allBodies(engine.world).filter(x => x.label === 'k');
            console.debug(allK)
            let sb = allK[selectedBox];
            if (ev.keyCode === 39) {
                // right 
                Body.setVelocity(sb, { x: 5, y: sb.velocity.y })
            }
            if (ev.keyCode === 37) {
                // left
                Body.setVelocity(sb, { x: -5, y: sb.velocity.y })
            }
            if (ev.keyCode === 38) {
                // up
                Body.setVelocity(sb, { x: sb.velocity.x, y: getUpVel() })
                clearInterval(vel);
                keyupTimer = 0;
            }
            if (ev.keyCode === 40) {
                // down
                Body.setVelocity(sb, { x: 0, y: 0 })
            }
            if (ev.keyCode === 70 || ev.keyCode === 102) {
                // f
                selectedBox = selectedBox === allK.length - 1 ? 0 : selectedBox + 1;
                allK.map(x => {
                    x.render.fillStyle = defaultBoxColor;
                });
                sb = allK[selectedBox];
                sb.render.fillStyle = selectedBoxColor;
                document.getElementById('selebox').innerText = selectedBox;
            }
            if (ev.keyCode === 83 || ev.keyCode === 115) {
                // s
                let ner = Bodies.rectangle(400, 200, 80, 80, { label: 'k', render: { fillStyle: defaultBoxColor } });
                Composite.addBody(engine.world, ner)
            }
            if (ev.keyCode === 32) {
                // mezernik
                Matter.Sleeping.set(sb, true);
            }
        })
    </script>
</body>

</html>